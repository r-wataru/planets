<%
@page_title_icon = 'book'
@page_title_text = "掲示板"
@javascript = 'CommentAction'

@breadcrumbs = [
  [ 'home', 'トップ', :root ],
  [ 'paper-plane', '掲示板', :posts ]]

new_form_options = {
  url: [ @post, :comments ],
  html: { class: "form-horizontal", role: 'form' },
  method: :post
}
%>

<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="panel panel-default">
      <div class="panel-heading">
        <%= content_tag :span, @post.publication? ? "OPEN" : "CLOSE",
          class: "label label-#{ @post.publication? ? 'success' : 'danger'}" %>
        <%= @post.title %>
      </div>
      <div class="panel-body">
        <div>
          <% if @post.user.present? %>
            <% if @post.user.image && @post.user.image.thumbnail.present? %>
              <%= image_tag thumbnail_user_path(@post.user, format: @post.user.image.extension), size: "40x40" %>
            <% else %>
              <%= image_tag "user.png", alt: "logo", size: "40x40" %>
            <% end %>
          <% else %>
            <%= image_tag "user.png", alt: "logo", size: "40x40" %>
          <% end %>
          <b style="margin-left: 10px;"><%= @post.user.present? ? @post.user.display_name : "名無しさん" %></b>
          <hr>
        </div>
        <%= simple_format(@post.description) %>
      </div>
      <div class="panel-footer">
        <div class="row">
          <div class="col-md-12">
            <%= content_tag :p, style: "margin: 0; text-align: right;" do %>
              <%= link_to fa_icon('pencil'), [ :edit, @post ], style: "margin-right: 10px;" %>
              <%= link_to fa_icon('trash'), @post, data: { confirm: "Are Your Sure?" }, method: :delete %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <% @comments.each do |comment| %>
      <div class="panel panel-default">
        <div class="panel-body">
          <div>
            <% if comment.user.present? %>
              <% if comment.user.image && comment.user.image.thumbnail.present? %>
                <%= image_tag thumbnail_user_path(comment.user, format: comment.user.image.extension), size: "40x40" %>
              <% else %>
                <%= image_tag "user.png", alt: "logo", size: "40x40" %>
              <% end %>
            <% else %>
              <%= image_tag "user.png", alt: "logo", size: "40x40" %>
            <% end %>
            <b style="margin-left: 10px;"><%= comment.user.present? ? comment.user.display_name : "名無しさん" %></b>
            <hr>
          </div>
          <%= image_tag comment_image_path(comment.image, format: comment.image.extension),
            style: "max-width: 100%;" if comment.image.present? && comment.image.data.present? %>
          <%= simple_format(comment.comment) %>
        </div>
        <div class="panel-footer">
          <div class="row">
            <div class="col-md-6">
              <% if current_user %>
                <% if current_user.user_comment_links.exists?(comment: comment) %>
                  <span class="goodAddOrDeleteButton" data-int="<%= comment.id %>" data-user-int="<%= current_user.id %>">いいねを取り消す</span>
                <% else %>
                  <span class="goodAddOrDeleteButton" data-int="<%= comment.id %>" data-user-int="<%= current_user.id %>">いいね</span>
                <% end %>
              <% end %>
              <%= fa_icon("thumbs-o-up") %>
              <span id="goodCount<%= comment.id %>" class="goodCountButton" data-int="<%= comment.id %>" data-toggle="modal" data-target=".bs-example-modal-sm-<%= comment.id %>"><%= UserCommentLink.where(comment: comment).count %></span>

              <div class="modal fade bs-example-modal-sm-<%= comment.id %>" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-sm">
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <h4 class="modal-title">いいねリスト</h4>
                    </div>
                    <div class="modal-body">
                      <div class="mainImage<%= comment.id %>">

                      </div>
                      <% if UserCommentLink.exists?(comment: comment) %>
                        <% UserCommentLink.where(comment: comment).each do |like| %>
                          <% if like.user.present? %>
                            <% if like.user.image && like.user.image.thumbnail.present? %>
                              <%= image_tag thumbnail_user_path(like.user, format: like.user.image.extension), size: "40x40" %>
                            <% else %>
                              <%= image_tag "user.png", alt: "logo", size: "40x40" %>
                            <% end %>
                          <% else %>
                            <%= image_tag "user.png", alt: "logo", size: "40x40" %>
                          <% end %>
                          <b style="margin-left: 10px;"><%= like.user.display_name %></b>
                          <hr>
                        <% end %>
                      <% else %>
                        <p>まだ誰もいません。</p>
                      <% end %>

                    </div>
                  </div>
                </div>
              </div>

            </div>
            <div class="col-md-6">
              <%= content_tag :p, style: "margin: 0; text-align: right;" do %>
                <%= link_to fa_icon('trash'), [ @post, comment ], data: { confirm: "Are You Sure?" }, method: :delete %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <div class="panel panel-default">
      <div class="panel-heading">コメントを書く</div>
      <div class="panel-body">
        <%= form_for @comment_form, new_form_options do |f| %>

          <%= f.fields_for :image, f.object.comment.image do |fff| %>
            <%= markup do |m|
              p = HorizontalFormPresenter.new(fff, self)
              p.with_options(required: false) do |q|
                m << q.file_block(:uploaded_image, "画像", "", "", columns: 10, style: "margin-bottom: 10px;")
              end
            end %>
          <% end %>

          <%= f.fields_for :comment, f.object.comment do |ff| %>
            <%= markup do |m|
              p = HorizontalFormPresenter.new(ff, self)
              p.with_options(required: true) do |q|
                m << q.text_area_block(:comment, "コメント", columns: 10)
              end
              m << p.submit_button
            end %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>